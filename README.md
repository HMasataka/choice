# choice

Go で実装された WebRTC SFU (Selective Forwarding Unit)

## 概要

choice は多人数ビデオ会議を実現する WebRTC SFU サーバーです。パブリッシャーからメディアストリームを受信し、サブスクライバーに選択的に転送することで、クライアント間のメッシュ接続を必要とせず、効率的なリアルタイム通信を可能にします。

## アーキテクチャ

```text
┌────────────────────────────────────────────────────────────────┐
│                            SFU                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                       Session                           │   │
│  │  ┌─────────────┐           ┌─────────────┐              │   │
│  │  │    Peer A   │           │    Peer B   │              │   │
│  │  │ ┌─────────┐ │           │ ┌─────────┐ │              │   │
│  │  │ │Publisher│ │           │ │Publisher│ │              │   │
│  │  │ └────┬────┘ │           │ └────┬────┘ │              │   │
│  │  │      │      │           │      │      │              │   │
│  │  │ ┌────▼────┐ │           │ ┌────▼────┐ │              │   │
│  │  │ │ Router  │─┼───────────┼─│ Router  │ │              │   │
│  │  │ └────┬────┘ │           │ └────┬────┘ │              │   │
│  │  │      │      │           │      │      │              │   │
│  │  │ ┌────▼────┐ │           │ ┌────▼────┐ │              │   │
│  │  │ │Subscriber│◄───────────┼─│Subscriber│ │              │   │
│  │  │ └─────────┘ │           │ └─────────┘ │              │   │
│  │  └─────────────┘           └─────────────┘              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## パッケージ構成

```tree
pkg/sfu/
├── sfu.go          # SFU コア - セッション管理と WebRTC API
├── session.go      # セッション（ルーム）管理
├── router.go       # パブリッシャーからサブスクライバーへのメディアルーティング
├── peer.go         # クライアントの抽象化（Publisher + Subscriber）
├── publisher.go    # アップストリーム接続（クライアント → SFU）
├── subscriber.go   # ダウンストリーム接続（SFU → クライアント）
├── receiver.go     # RTP パケットの受信と転送
├── downtrack.go    # RTP パケットの送信（シーケンス番号書き換え付き）
├── signaling.go    # JSON-RPC シグナリングハンドラーと型定義
└── transport.go    # WebSocket 接続ラッパー（スレッドセーフ）
```

### コンポーネント説明

| コンポーネント       | 説明                                                                                       |
| -------------------- | ------------------------------------------------------------------------------------------ |
| **SFU**              | メインエントリーポイント。セッションを管理し、WebRTC ピア接続を作成する。                  |
| **Session**          | ピアが参加してメディアを共有できるルーム。                                                 |
| **Router**           | パブリッシャーから複数のサブスクライバーへメディアをルーティング。新トラック追加時に通知。 |
| **Peer**             | 接続されたクライアントを表す。Publisher と Subscriber の両方を保持。                       |
| **Publisher**        | クライアントからの受信メディアを処理。各トラックの Receiver を作成。                       |
| **Subscriber**       | クライアントへの送信メディアを処理。SDP ネゴシエーションを管理。                           |
| **Receiver**         | リモートトラックから RTP パケットを受信し、DownTrack に転送。                              |
| **DownTrack**        | サブスクライバーに RTP パケットを送信（シーケンス番号書き換え付き）。                      |
| **SignalingHandler** | WebSocket 上の JSON-RPC シグナリングを処理。                                               |
| **wsConn**           | スレッドセーフな WebSocket 接続ラッパー。                                                  |

## シグナリングプロトコル

SFU は WebSocket 上で JSON-RPC 2.0 を使用してシグナリングを行います。

### メソッド

| メソッド    | 説明                                        |
| ----------- | ------------------------------------------- |
| `join`      | SDP オファーを使用してセッションに参加      |
| `leave`     | 現在のセッションから退出                    |
| `subscribe` | 他のピアのメディアを購読                    |
| `candidate` | ICE 候補を交換                              |
| `answer`    | サブスクライバー接続用の SDP アンサーを送信 |

### 通知（サーバー → クライアント）

| メソッド     | 説明                                  |
| ------------ | ------------------------------------- |
| `offer`      | サブスクライバー接続用の SDP オファー |
| `candidate`  | サーバーからの ICE 候補               |
| `trackAdded` | ピアから新しいトラックが利用可能      |

### 例: join

リクエスト:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "join",
  "params": {
    "sessionId": "room1",
    "peerId": "peer-abc123",
    "offer": { "type": "offer", "sdp": "..." }
  }
}
```

レスポンス:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "answer": { "type": "answer", "sdp": "..." }
  }
}
```

## はじめに

### 前提条件

- Go 1.19 以降

### インストール

```bash
git clone choice
cd choice
go mod tidy
```

### サーバーの起動

```bash
go run cmd/server/main.go
```

サーバーは `http://localhost:8080` で起動します。

### Web クライアントの使用方法

ブラウザで `http://localhost:8080` を開きます。クライアントでは以下の操作が可能です:

1. Session ID（ルーム名）を入力
2. Peer ID（自分の名前）を入力
3. 「Join」をクリックして接続
4. ローカルのカメラ映像が表示される
5. 他の参加者の映像が自動的に表示される

### ビルド

```bash
go build -o choice ./cmd/server
./choice
```

### テスト

```bash
go test ./...
```

## 設定

SFU は ICE サーバーで設定できます:

```go
sfu := sfu.NewSFU(sfu.Config{
    ICEServers: []webrtc.ICEServer{
        {URLs: []string{"stun:stun.l.google.com:19302"}},
    },
})
```

## ライセンス

このプロジェクトは MIT ライセンスの下でライセンスされています。
